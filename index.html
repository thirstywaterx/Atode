<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudode - å®æ—¶AIåŠ©æ‰‹</title>
    <!-- å¼•å…¥ marked.js å’Œ highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">

    <style>
        /* åŸºç¡€é‡ç½®å’Œå¸ƒå±€ */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #output {
            position: relative;
            top: 50px;
            width: 90%;
            min-height: calc(100vh - 200px);
            left: 50%;
            transform: translateX(-50%);
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        #space {
            position: relative;
            bottom: 0;
            width: 100%;
            height: 200px;
        }

        #prompt_input {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            height: 100px;
            background-color: white;
            margin-bottom: 25px;
        }

        .prompt_button {
            position: absolute;
            bottom: 3px;
            right: 3px;
        }

        #user {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 180px;
            height: 55px;
            background-color: #f6f8fa;
        }

        #user .menu-button {
            position: relative;
            float: right;
            width: 40px;
            height: 40px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 100%;
            margin-right: -4px;
        }

        #user .menu-button svg {
            transform: scale(0.8);
            fill: #40484C;
        }

        #user-avatar {
            position: relative;
            float: right;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            border-radius: 100%;
            margin-left: 18px;
        }

        /* åŸºç¡€Markdownæ ·å¼ */
        .markdown-content {
            line-height: 1.6;
            margin: 1em 0;
        }

        .markdown-content pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
        }

        :not(:defined) {
            display: none;
        }

        .dialog {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
        }

        .dialog>.text-field {
            flex-grow: 1;
            width: auto;
        }

        .dialog>.link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .875rem;
        }

        .dialog>.link>a {
            color: var(--s-color-primary);
            text-decoration: none;
        }

        .dialog>.other {
            display: flex;
            gap: 16px;
            justify-content: center;
            padding: 0 24px;
        }
    </style>
</head>

<body>
    <s-page>
            <s-dialog showed="false">
                <div slot="headline">ç™»å½•/æ³¨å†Œ</div>
                <div class="dialog">
                    <s-text-field class="text-field" label="è¯·è¾“å…¥ç”¨æˆ·å">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" slot="start">
                            <path
                                d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z">
                            </path>
                        </svg>
                    </s-text-field>
                    <s-text-field class="text-field" style="margin-top: 8px;" label="è¯·è¾“å…¥å¯†ç " type="password">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" slot="start">
                            <path
                                d="M80-200v-80h800v80H80Zm46-242-52-30 34-60H40v-60h68l-34-58 52-30 34 58 34-58 52 30-34 58h68v60h-68l34 60-52 30-34-60-34 60Zm320 0-52-30 34-60h-68v-60h68l-34-58 52-30 34 58 34-58 52 30-34 58h68v60h-68l34 60-52 30-34-60-34 60Zm320 0-52-30 34-60h-68v-60h68l-34-58 52-30 34 58 34-58 52 30-34 58h68v60h-68l34 60-52 30-34-60-34 60Z">
                            </path>
                        </svg>
                        <s-icon-button slot="end">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                <path
                                    d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z">
                                </path>
                            </svg>
                        </s-icon-button>
                    </s-text-field>
                    <div class="link">
                    </div>
                    <s-button id="submit" style="border-radius: 4px;box-shadow: none;" onclick="login()">
                        <s-circular-progress indeterminate="true" slot="start" id="progress"
                            style="display: none;"></s-circular-progress> ç™»å½•
                    </s-button>
                    <s-button type="outlined" style="border-radius: 4px;">æ³¨å†Œè´¦å·</s-button>
                </div>
            </s-dialog>

            <s-card id="user">
                <s-popup-menu id="user-avatar">
                    <s-ripple style="border-radius: 100%;" slot="trigger"><s-avatar>US</s-avatar></s-ripple>
                    <s-popup-menu-item id="signin-button">ç™»å½•</s-popup-menu-item>
                </s-popup-menu>

                <s-ripple class="menu-button">
                    <svg viewBox="0 -960 960 960">
                        <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"></path>
                    </svg>
                </s-ripple>

                <s-popup class="menu-button">

                    <s-icon-button slot="trigger">
                        <svg viewBox="0 -960 960 960" style="transform: scale(1.4);">
                            <path
                                d="M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z">
                            </path>
                        </svg>
                    </s-icon-button>

                    <div style="min-height: 280px; width: 256px">

                    </div>

                </s-popup>


                <s-ripple class="menu-button">
                    <svg viewBox="0 -960 960 960" style="transform: scale(0.78);">
                        <path
                            d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z">
                        </path>
                    </svg>
                </s-ripple>

            </s-card>

            <div id="output"></div>
            <div id="space"></div>


            <s-text-field id="prompt_input" label="è¯·è¾“å…¥Prompt" type="multiLine" style="min-height: 96px">
                <s-icon-button class="prompt_button" id="send" slot="end">
                    <svg viewBox="0 -960 960 960">
                        <path
                            d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z">
                        </path>
                    </svg>
                </s-icon-button>
            </s-text-field>

        </s-page>

        <script src="./node_modules/sober/dist/sober.min.js"></script>
        <script>
            const signinButton = document.getElementById('signin-button');
            const dialog = document.querySelector('s-dialog');
            const userAvatar = document.getElementById('user-avatar');
            const registerButton = document.querySelector('s-button[type="outlined"]');
            const loginButton = document.getElementById('submit');
            const progressIndicator = document.getElementById('progress');
            let currentUser = null;

            // æ£€æŸ¥ä¼šè¯çŠ¶æ€
            async function checkSession() {
                try {
                    const response = await fetch('/api/session');
                    const data = await response.json();
                    if (data.success && data.user) {
                        currentUser = data.user;
                        updateUIForLoggedInUser(data.user);
                    } else {
                        updateUIForLoggedOutUser();
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ä¼šè¯å¤±è´¥:', error);
                    updateUIForLoggedOutUser();
                }
            }

            // æ›´æ–°å·²ç™»å½•ç”¨æˆ·çš„UI
            function updateUIForLoggedInUser(user) {
                const avatar = userAvatar.querySelector('s-avatar');
                avatar.innerText = user.username.substring(0, 2).toUpperCase();
                
                // æ›´æ–°ç”¨æˆ·èœå•
                const userMenu = document.getElementById('signin-button');
                userMenu.innerText = 'ç™»å‡º';
                
                console.log('ç”¨æˆ·å·²ç™»å½•:', user.username);
            }

            // æ›´æ–°æœªç™»å½•ç”¨æˆ·çš„UI
            function updateUIForLoggedOutUser() {
                const avatar = userAvatar.querySelector('s-avatar');
                avatar.innerText = 'US';
                
                // æ›´æ–°ç”¨æˆ·èœå•
                const userMenu = document.getElementById('signin-button');
                userMenu.innerText = 'ç™»å½•';
                
                currentUser = null;
                console.log('ç”¨æˆ·æœªç™»å½•');
            }

            // å¤„ç†ç™»å½•
            async function login() {
                const usernameField = document.querySelector('s-text-field[label="è¯·è¾“å…¥ç”¨æˆ·å"]');
                const passwordField = document.querySelector('s-text-field[label="è¯·è¾“å…¥å¯†ç "]');
                const username = usernameField.value;
                const password = passwordField.value;
                
                if (!username || !password) {
                    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                    return;
                }
                
                try {
                    progressIndicator.style.display = 'inline-block';
                    loginButton.disabled = true;
                    
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username,
                            password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        dialog.showed = false;
                        currentUser = data.user;
                        updateUIForLoggedInUser(data.user);
                        passwordField.value = '';
                    } else {
                        alert(data.error || 'ç™»å½•å¤±è´¥');
                    }
                } catch (error) {
                    console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                    alert('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                } finally {
                    progressIndicator.style.display = 'none';
                    loginButton.disabled = false;
                }
            }

            // å¤„ç†æ³¨å†Œ
            async function register() {
                const usernameField = document.querySelector('s-text-field[label="è¯·è¾“å…¥ç”¨æˆ·å"]');
                const passwordField = document.querySelector('s-text-field[label="è¯·è¾“å…¥å¯†ç "]');
                
                const username = usernameField.value;
                const password = passwordField.value;
                
                if (!username || !password) {
                    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                    return;
                }
                
                try {
                    progressIndicator.style.display = 'inline-block';
                    registerButton.disabled = true;
                    
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username,
                            password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                        // ä¿æŒå¯¹è¯æ¡†æ‰“å¼€ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥ç™»å½•
                    } else {
                        alert(data.error || 'æ³¨å†Œå¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ³¨å†Œè¯·æ±‚å¤±è´¥:', error);
                    alert('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                } finally {
                    progressIndicator.style.display = 'none';
                    registerButton.disabled = false;
                }
            }

            // å¤„ç†ç™»å‡º
            async function logout() {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        updateUIForLoggedOutUser();
                    }
                } catch (error) {
                    console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error);
                }
            }

            // äº‹ä»¶ç›‘å¬å™¨
            window.addEventListener('load', checkSession);
            
            signinButton.addEventListener('click', function() {
                if (currentUser) {
                    // å·²ç™»å½•ï¼Œæ‰§è¡Œç™»å‡º
                    logout();
                } else {
                    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•å¯¹è¯æ¡†
                    dialog.showed = true;
                }
            });

            loginButton.addEventListener('click', login);
            registerButton.addEventListener('click', register);
        </script>
        <script>
            const output = document.getElementById('output');
            const promptInput = document.getElementById('prompt_input');
            const submitButton = document.querySelector('#send');

            // WebSocketè¿æ¥å’ŒçŠ¶æ€ç®¡ç†
            let ws = null;
            let isConnected = false;
            let isProcessing = false;
            let conversationHistory = [];
            let currentMessageId = null;

            // ä¿®æ­£SVGå›¾æ ‡
            const sendIcon = `<svg viewBox="0 -960 960 960"><path d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z"></path></svg>`;
            const stopIcon = `<svg viewBox="0 -960 960 960"><path d="M520-200v-560h240v560H520Zm-320 0v-560h240v560H200Z"></path></svg>`;

            // é…ç½® marked.js
            marked.setOptions({
                highlight: function (code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) { }
                    }
                    return hljs.highlightAuto(code).value;
                },
                langPrefix: 'hljs language-',
                breaks: true,
                gfm: true
            });

            // åˆå§‹åŒ–WebSocketè¿æ¥
            function initWebSocket() {
                const wsUrl = `ws://${window.location.host}`;
                console.log('ğŸ”Œ è¿æ¥WebSocket:', wsUrl);

                ws = new WebSocket(wsUrl);

                ws.onopen = function (event) {
                    console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    isConnected = true;
                };

                ws.onmessage = function (event) {
                    console.log('ğŸ”” åŸå§‹WebSocketæ¶ˆæ¯:', event.data);
                    try {
                        const message = JSON.parse(event.data);
                        handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('âŒ æ¶ˆæ¯è§£æå¤±è´¥:', error, 'åŸå§‹æ•°æ®:', event.data);
                    }
                };

                ws.onclose = function (event) {
                    console.log('âŒ WebSocketè¿æ¥å…³é—­', event.code, event.reason);
                    isConnected = false;
                    isProcessing = false;

                    // 5ç§’åå°è¯•é‡è¿
                    setTimeout(initWebSocket, 5000);
                };

                ws.onerror = function (error) {
                    console.error('WebSocketé”™è¯¯:', error);
                };
            }

            // å¤„ç†WebSocketæ¶ˆæ¯
            function handleWebSocketMessage(message) {
                console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ç±»å‹:', message.type);
                console.log('ğŸ“Š å®Œæ•´æ¶ˆæ¯å†…å®¹:', message);

                switch (message.type) {
                    case 'processing_start':
                        console.log('ğŸš€ å¼€å§‹å¤„ç†...');
                        isProcessing = true;
                        setProcessingState(true);
                        currentMessageId = `msg-${Date.now()}`;
                        const startDiv = `<div id="${currentMessageId}"><p><strong>AIï¼š</strong>æ­£åœ¨å¤„ç†...</p></div>`;
                        output.innerHTML += startDiv;
                        console.log('âœ… å·²æ·»åŠ å¤„ç†å®¹å™¨:', currentMessageId);
                        break;

                    case 'coordination_progress':
                        console.log('ğŸ”„ åè°ƒè¿›åº¦:', message.message, message.progress + '%');
                        const progressContainer = document.getElementById(currentMessageId);
                        if (progressContainer) {
                            progressContainer.innerHTML = `<p><strong>AIï¼š</strong>ğŸš€ ${message.stage}/6 ${message.message}</p>`;
                            console.log('âœ… å·²æ›´æ–°è¿›åº¦æ˜¾ç¤º');
                        } else {
                            console.warn('âš ï¸ æ‰¾ä¸åˆ°è¿›åº¦å®¹å™¨:', currentMessageId);
                        }
                        break;

                    case 'stream_start':
                        console.log('ğŸŸ¢ å¼€å§‹æµå¼ä¼ è¾“');
                        const startContainer = document.getElementById(currentMessageId);
                        if (startContainer) {
                            startContainer.innerHTML = `<p><strong>AIï¼š</strong></p><div class="markdown-content">å¼€å§‹æ¥æ”¶å†…å®¹...</div>`;
                            console.log('âœ… å·²å‡†å¤‡å†…å®¹å®¹å™¨');
                        } else {
                            console.warn('âš ï¸ æ‰¾ä¸åˆ°å¼€å§‹å®¹å™¨:', currentMessageId);
                        }
                        break;

                    case 'stream_chunk':
                        console.log('ğŸ“¦ æ”¶åˆ°æ•°æ®å—ï¼Œå†…å®¹é•¿åº¦:', message.fullContent ? message.fullContent.length : 0);
                        console.log('ğŸ“‹ æ•°æ®å—å†…å®¹é¢„è§ˆ:', message.fullContent ? message.fullContent.substring(0, 100) + '...' : 'æ— å†…å®¹');

                        const container = document.getElementById(currentMessageId);
                        if (container) {
                            console.log('âœ… æ‰¾åˆ°å®¹å™¨:', currentMessageId);
                            if (message.fullContent) {
                                let contentDiv = container.querySelector('.markdown-content');
                                if (!contentDiv) {
                                    console.log('âš ï¸ åˆ›å»ºæ–°çš„å†…å®¹å®¹å™¨');
                                    contentDiv = document.createElement('div');
                                    contentDiv.className = 'markdown-content';
                                    container.innerHTML = '<p><strong>AIï¼š</strong></p>';
                                    container.appendChild(contentDiv);
                                }

                                try {
                                    contentDiv.innerHTML = parseMarkdown(message.fullContent);
                                    console.log('âœ… å·²æ›´æ–°é¡µé¢å†…å®¹ï¼Œå½“å‰é•¿åº¦:', contentDiv.innerHTML.length);
                                } catch (parseError) {
                                    console.error('âŒ Markdownè§£æå¤±è´¥:', parseError);
                                    contentDiv.textContent = message.fullContent;
                                }
                            } else {
                                console.warn('âš ï¸ æ•°æ®å—æ²¡æœ‰fullContent');
                            }
                        } else {
                            console.error('âŒ æ‰¾ä¸åˆ°å®¹å™¨:', currentMessageId, 'å½“å‰æ‰€æœ‰å®¹å™¨:', document.querySelectorAll('[id^="msg-"]'));
                        }
                        break;

                    case 'stream_complete':
                        console.log('âœ… æµå¼ä¼ è¾“å®Œæˆï¼Œæœ€ç»ˆå†…å®¹é•¿åº¦:', message.fullContent ? message.fullContent.length : 0);
                        if (currentMessageId) {
                            const container = document.getElementById(currentMessageId);
                            if (container) {
                                const finalContent = message.fullContent || message.content || '';
                                console.log('ğŸ“ æœ€ç»ˆå†…å®¹é¢„è§ˆ:', finalContent.substring(0, 200) + '...');

                                let contentDiv = container.querySelector('.markdown-content');
                                if (!contentDiv) {
                                    contentDiv = document.createElement('div');
                                    contentDiv.className = 'markdown-content';
                                    container.innerHTML = '<p><strong>AIï¼š</strong></p>';
                                    container.appendChild(contentDiv);
                                }

                                if (finalContent) {
                                    try {
                                        contentDiv.innerHTML = parseMarkdown(finalContent);
                                        conversationHistory.push({ role: 'assistant', content: finalContent });
                                        console.log('âœ… å·²ä¿å­˜åˆ°å†å²è®°å½•ï¼Œå½“å‰å†å²é•¿åº¦:', conversationHistory.length);
                                    } catch (parseError) {
                                        console.error('âŒ æœ€ç»ˆå†…å®¹è§£æå¤±è´¥:', parseError);
                                        contentDiv.textContent = finalContent;
                                    }
                                } else {
                                    console.warn('âš ï¸ æ²¡æœ‰æœ€ç»ˆå†…å®¹');
                                    contentDiv.innerHTML = '<p><em>æœªæ”¶åˆ°å†…å®¹</em></p>';
                                }
                            } else {
                                console.error('âŒ å®Œæˆæ—¶æ‰¾ä¸åˆ°å®¹å™¨:', currentMessageId);
                            }
                        }
                        isProcessing = false;
                        setProcessingState(false);
                        break;

                    case 'error':
                        console.error('âŒ æ”¶åˆ°é”™è¯¯:', message.message);
                        isProcessing = false;
                        setProcessingState(false);
                        output.innerHTML += `<p><strong>é”™è¯¯:</strong> ${message.message}</p>`;
                        break;

                    default:
                        console.log('â“ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type, message);
                }

                output.scrollTop = output.scrollHeight;
            }

            // ç›‘å¬æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            submitButton.addEventListener('click', async (event) => {
                event.preventDefault();

                if (isProcessing) {
                    await stopProcessing();
                } else {
                    await sendPromptWebSocket();
                }
            });

            // ç›‘å¬è¡¨å•æäº¤äº‹ä»¶
            promptInput.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!isProcessing) {
                    await sendPromptWebSocket();
                }
            });

            // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
            async function sendPromptWebSocket() {
                const prompt = promptInput.value.trim();

                if (!prompt) {
                    alert('è¯·è¾“å…¥å†…å®¹');
                    return;
                }

                if (!isConnected) {
                    alert('WebSocketæœªè¿æ¥ï¼Œè¯·ç­‰å¾…è¿æ¥æ¢å¤');
                    return;
                }

                if (isProcessing) {
                    alert('AIæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™');
                    return;
                }

                // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
                output.innerHTML += `<p><strong>ç”¨æˆ·:</strong> ${prompt}</p>`;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²è®°å½•
                conversationHistory.push({
                    role: 'user',
                    content: prompt
                });

                // æ›´ç²¾ç¡®çš„æ„å›¾è¯†åˆ«
                const lowerPrompt = prompt.toLowerCase();

                // é¦–å…ˆæ£€æµ‹æ–‡å­—åˆ›ä½œéœ€æ±‚
                const isWritingRequest = /å†™.*?(å°è¯´|æ•…äº‹|æ–‡ç« |æ•£æ–‡|è¯—æ­Œ|å‰§æœ¬|æ—¥è®°|ä¼ è®°|æŠ¥å‘Š|è®ºæ–‡|è¯´æ˜|ä»‹ç»|åˆ†æ|è¯„è®º|æ€»ç»“)/.test(lowerPrompt) ||
                    /åˆ›ä½œ.*?(å°è¯´|æ•…äº‹|æ–‡ç« |æ•£æ–‡|è¯—æ­Œ|å‰§æœ¬)/.test(lowerPrompt) ||
                    /^(å°è¯´|æ•…äº‹|æ–‡ç« |æ•£æ–‡|è¯—æ­Œ|å‰§æœ¬|æ—¥è®°|ä¼ è®°|æŠ¥å‘Š|è®ºæ–‡|è¯´æ˜|ä»‹ç»|åˆ†æ|è¯„è®º|æ€»ç»“)/.test(lowerPrompt);

                // æ£€æµ‹ä»£ç å¼€å‘éœ€æ±‚
                const isCodeRequest = /å†™|ç”Ÿæˆ|åˆ›å»º|åˆ¶ä½œ.*?(ç½‘é¡µ|ç½‘ç«™|é¡µé¢|ä»£ç |html|css|js|ç¨‹åº|åº”ç”¨|ä¸»é¡µ|ç•Œé¢|å¸ƒå±€|ç³»ç»Ÿ)/.test(lowerPrompt) ||
                    /å¼€å‘|è®¾è®¡|å®ç°.*?(é¡µé¢|ç½‘ç«™|ç½‘é¡µ|åº”ç”¨|ç³»ç»Ÿ)/.test(lowerPrompt);

                // æ˜ç¡®çš„å¦å®š
                const explicitNoCode = /ä¸è¦.*ä»£ç |ä¸å†™.*ä»£ç |ä¸éœ€è¦.*ä»£ç |åªè¦.*æ–‡å­—|åªéœ€è¦.*æ–‡å­—|çº¯æ–‡å­—è¯´æ˜/.test(lowerPrompt);

                // ä¼˜å…ˆçº§ï¼šå†™ä½œéœ€æ±‚ > æ˜ç¡®ä¸è¦ä»£ç  > ä»£ç éœ€æ±‚
                let useCoordinator;
                if (isWritingRequest || explicitNoCode) {
                    useCoordinator = true;  // æ–‡å­—åˆ›ä½œä¹Ÿä½¿ç”¨åè°ƒå™¨ï¼Œä½†ä¼šåˆ†é…ç»™å†™ä½œAI
                    console.log('ğŸ“ è¯†åˆ«ä¸ºæ–‡å­—åˆ›ä½œéœ€æ±‚ï¼Œä½¿ç”¨å†™ä½œä¸“å®¶AI');
                } else if (isCodeRequest) {
                    useCoordinator = true;  // ä»£ç å¼€å‘ä½¿ç”¨åè°ƒå™¨ï¼Œåˆ†é…ç»™ä»£ç AI
                    console.log('ğŸ’» è¯†åˆ«ä¸ºä»£ç å¼€å‘éœ€æ±‚ï¼Œä½¿ç”¨ä»£ç ä¸“å®¶AI');
                } else {
                    useCoordinator = false; // æ™®é€šé—®ç­”ä¸ä½¿ç”¨åè°ƒå™¨
                    console.log('ğŸ’¬ è¯†åˆ«ä¸ºæ™®é€šé—®ç­”ï¼Œä½¿ç”¨åŸºç¡€AI');
                }

                console.log(`ğŸ¤– æ™ºèƒ½åˆ¤æ–­: å†™ä½œéœ€æ±‚=${isWritingRequest}, ä»£ç éœ€æ±‚=${isCodeRequest}, æ˜ç¡®ä¸è¦ä»£ç =${explicitNoCode}, ä½¿ç”¨åè°ƒå™¨=${useCoordinator}`);

                // é€šè¿‡WebSocketå‘é€è¯·æ±‚
                const message = {
                    prompt: prompt,
                    history: conversationHistory,
                    useCoordinator: useCoordinator
                };

                console.log('ğŸ“¤ å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨:', message);
                ws.send(JSON.stringify(message));

                promptInput.value = '';
                output.scrollTop = output.scrollHeight;
            }

            // åœæ­¢å¤„ç†
            async function stopProcessing() {
                if (isConnected && ws) {
                    ws.send(JSON.stringify({ type: 'stop_task' }));
                }

                // ç«‹å³æ›´æ–°UIçŠ¶æ€
                isProcessing = false;
                setProcessingState(false);

                // ç«‹å³åœ¨UIä¸Šæ˜¾ç¤ºä»»åŠ¡å·²åœæ­¢
                const container = document.getElementById(currentMessageId);
                if (container) {
                    container.innerHTML += '<p><strong>ç³»ç»Ÿ:</strong> ä»»åŠ¡å·²åœæ­¢ã€‚</p>';
                }
            }

            function setProcessingState(processing) {
                isProcessing = processing;
                if (processing) {
                    submitButton.innerHTML = stopIcon;
                    submitButton.setAttribute('aria-label', 'åœæ­¢å¤„ç†');
                } else {
                    submitButton.innerHTML = sendIcon;
                    submitButton.setAttribute('aria-label', 'å‘é€æ¶ˆæ¯');
                }
            }

            /**
             * ä½¿ç”¨ marked.js è§£æ Markdown
             */
            function parseMarkdown(markdown) {
                if (!markdown || typeof markdown !== 'string') {
                    return markdown;
                }

                try {
                    // 1. ä½¿ç”¨ marked.js è§£æ Markdown
                    let html = marked.parse(markdown);

                    // 2. ä½¿ç”¨ DOMPurify æ¸…ç†HTMLï¼Œé˜²æ­¢XSSæ”»å‡»
                    html = DOMPurify.sanitize(html);

                    return html;
                } catch (error) {
                    console.error('Markdown è§£æé”™è¯¯:', error);
                    return markdown;
                }
            }

            // å¿ƒè·³æ£€æµ‹
            function startHeartbeat() {
                setInterval(() => {
                    if (isConnected && ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000); // 30ç§’å¿ƒè·³
            }

            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–WebSocket
            window.addEventListener('load', () => {
                initWebSocket();
                startHeartbeat();
            });

            // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
            window.addEventListener('beforeunload', () => {
                if (ws) {
                    ws.close();
                }
            });
        </script>
</body>

</html>