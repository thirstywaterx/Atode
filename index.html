<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atode - å®æ—¶AIåŠ©æ‰‹</title>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
    <script src="./node_modules/marked/lib/marked.umd.js"></script>
    <script src="./node_modules/dompurify/dist/purify.min.js"></script>
    <script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css" />
    <style>
        /* åŸºç¡€é‡ç½®å’Œå¸ƒå±€ */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        s-scroll-view {
            position: absolute;
            top: 0;
            height: calc(100vh - 200px);
            width: 100%;
            padding-bottom: 200px;
        }

        s-page {
            height: 100vh;
            --color-icon: #40484c;
            --color-card: lightgray;
            --color-input: #f8f9fb;
        }

        s-page[dark] {
            --color-icon: #c0c8cc;
            --color-card: #40484c;
            --color-input: #111415;
        }

        #output {
            position: relative;
            top: 50px;
            min-width: 90%;
            max-width: 800px;
            min-height: calc(100vh - 200px);
            left: 50%;
            transform: translateX(-50%);
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        #prompt_input {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            height: 100px;
            margin-bottom: 25px;
            background-color: var(--color-input);
        }

        .prompt_button {
            position: absolute;
            bottom: 3px;
            right: 3px;
        }

        #user {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 180px;
            height: 55px;
            z-index: 1000;
        }

        #user .menu-button {
            position: relative;
            float: right;
            width: 40px;
            height: 40px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 100%;
            margin-right: -4px;
        }

        #user .menu-button svg {
            transform: scale(0.8);
        }

        #user-avatar {
            position: relative;
            float: right;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            border-radius: 100%;
            margin-left: 18px;
        }

        #new-chat {
            fill: var(--color-icon);
        }

        /* åŸºç¡€Markdownæ ·å¼ */
        .markdown-content {
            line-height: 1.6;
            margin: 1em 0;
        }

        .markdown-content pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
            position: relative;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .markdown-content code {
            background: #f6f8fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* æš—é»‘æ¨¡å¼ä¸‹çš„ä»£ç æ ·å¼ */
        s-page[dark] .markdown-content pre {
            background: #2d3748;
            color: #e2e8f0;
        }

        s-page[dark] .markdown-content code {
            background: #2d3748;
            color: #e2e8f0;
        }

        /* äº®è‰²ä¸»é¢˜ä¸‹ä»£ç å—èƒŒæ™¯æ›´æ·±ï¼ŒåŒºåˆ†é¡µé¢èƒŒæ™¯ */
        s-page:not([dark]) .markdown-content pre {
            background: #eaecef !important;
            color: #222 !important;
        }

        s-page:not([dark]) .markdown-content code {
            background: #eaecef !important;
            color: #222 !important;
        }

        /* æš—é»‘æ¨¡å¼è®¾ç½®åŒºåŸŸä¸€è¡Œå±…ä¸­ */
        .setting-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
        }

        /* highlightjs-copy æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .hljs-copy-button {
            position: absolute !important;
            top: 8px !important;
            right: 8px !important;
            opacity: 0.7 !important;
            background: rgba(0, 0, 0, 0.1) !important;
            color: var(--color-icon) !important;
            border: 1px solid rgba(0, 0, 0, 0.2) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
            cursor: pointer !important;
            z-index: 10 !important;
            transition: opacity 0.2s !important;
            pointer-events: auto !important;
            will-change: auto !important;
            transform: translateZ(0) !important;
        }

        .hljs-copy-button:hover {
            opacity: 1 !important;
            background: rgba(0, 0, 0, 0.2) !important;
        }

        /* ç¡®ä¿ä»£ç å—å®¹å™¨æœ‰ç›¸å¯¹å®šä½ï¼Œå®Œå…¨ç§»é™¤æ»šåŠ¨æ¡ */
        .markdown-content pre {
            position: relative !important;
            overflow: hidden !important;
            white-space: pre !important;
            word-wrap: break-word !important;
        }

        /* ä¿®å¤ä»£ç å—å†…å®¹æ ·å¼ï¼Œé˜²æ­¢æŠ½æ */
        .markdown-content pre code {
            display: block !important;
            overflow: visible !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            word-break: normal !important;
            max-width: 100% !important;
        }

        /* åªæœ‰åœ¨å†…å®¹ç¡®å®è¶…å‡ºæ—¶æ‰æ˜¾ç¤ºæ°´å¹³æ»šåŠ¨æ¡ */
        .markdown-content pre.code-overflow {
            overflow-x: auto !important;
            overflow-y: hidden !important;
        }

        /* é˜²æ­¢å¤åˆ¶æŒ‰é’®åœ¨æµå¼ä¼ è¾“æ—¶æŠ½åŠ¨ */
        .hljs-copy-button {
            position: absolute !important;
            top: 8px !important;
            right: 8px !important;
            opacity: 0.7 !important;
            background: rgba(0, 0, 0, 0.1) !important;
            color: var(--color-icon) !important;
            border: 1px solid rgba(0, 0, 0, 0.2) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
            cursor: pointer !important;
            z-index: 10 !important;
            transition: opacity 0.2s !important;
            pointer-events: auto !important;
            will-change: auto !important;
            transform: translateZ(0) !important;
        }

        .hljs-copy-button:hover {
            opacity: 1 !important;
            background: rgba(0, 0, 0, 0.2) !important;
        }

        :not(:defined) {
            display: none;
        }

        .dialog {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
        }

        .dialog>.text-field {
            flex-grow: 1;
            width: auto;
        }

        .dialog>.link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .875rem;
        }

        .dialog>.link>a {
            color: var(--s-color-primary);
            text-decoration: none;
        }

        .dialog>.other {
            display: flex;
            gap: 16px;
            justify-content: center;
            padding: 0 24px;
        }
    </style>
</head>

<body>
    <s-page theme="light">

        <s-snackbar>
            <div slot="trigger"></div>
            <p></p>
            <s-button slot="action" type="text"> å…³é—­ </s-button>
        </s-snackbar>

        <s-dialog showed="false">
            <div slot="headline">ç™»å½•/æ³¨å†Œ</div>
            <div class="dialog">
                <s-text-field class="text-field" label="è¯·è¾“å…¥ç”¨æˆ·å">
                    <svg xmlns="0 -969 960 960" viewBox="0 -960 960 960" slot="start">
                        <path
                            d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z">
                        </path>
                    </svg>
                </s-text-field>
                <s-text-field class="text-field" style="margin-top: 8px;" label="è¯·è¾“å…¥å¯†ç " type="password">
                    <svg xmlns="0 -969 960 960" viewBox="0 -960 960 960" slot="start">
                        <path
                            d="M80-200v-80h800v80H80Zm46-242-52-30 34-60H40v-60h68l-34-58 52-30 34 58 34-58 52 30-34 58h68v60h-68l34 60-52 30-34-60-34 60Zm320 0-52-30 34-60h-68v-60h68l-34-58 52-30 34 58 34-58 52 30-34 58h68v60h-68l34 60-52 30-34-60-34 60Zm320 0-52-30 34-60h-68v-60h68l-34-58 52-30 34 58 34-58 52 30-34 58h68v60h-68l34 60-52 30-34-60-34 60Z">
                        </path>
                    </svg>
                    <s-icon-button slot="end">
                        <svg xmlns="0 -969 960 960" viewBox="0 -960 960 960">
                            <path
                                d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z">
                            </path>
                        </svg>
                    </s-icon-button>
                </s-text-field>
                <s-button id="submit" style="border-radius: 4px;box-shadow: none;" onclick="login()">
                    <s-circular-progress indeterminate="true" slot="start" id="progress"
                        style="display: none;"></s-circular-progress> ç™»å½•
                </s-button>
                <s-button type="outlined" style="border-radius: 4px;">æ³¨å†Œè´¦å·</s-button>
            </div>
        </s-dialog>

        <s-card id="user">
            <s-popup-menu id="user-avatar">
                <s-ripple style="border-radius: 100%;" slot="trigger"><s-avatar></s-avatar></s-ripple>
                <s-popup-menu-item id="signin-button">ç™»å½•</s-popup-menu-item>
            </s-popup-menu>

            <s-ripple class="menu-button" id="new-chat">
                <svg viewBox="0 -960 960 960">
                    <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"></path>
                </svg>
            </s-ripple>

            <s-popup class="menu-button">

                <s-icon-button slot="trigger">
                    <svg viewBox="0 -969 960 960" style="transform: scale(1.4);">
                        <path
                            d="M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z">
                        </path>
                    </svg>
                </s-icon-button>

                <div style="min-height: 280px; width: 256px; overflow-y: auto; padding: 8px;">
                    <h3 style="margin: 8px 0; text-align: center;">å†å²å¯¹è¯è®°å½•</h3>
                    <div id="history-list" style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="history-loading" style="text-align: center; padding: 16px;">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                    <div id="history-empty" style="text-align: center; padding: 16px; display: none;">
                        æš‚æ— å†å²è®°å½•
                    </div>
                </div>

            </s-popup>


            <s-popup class="menu-button">
                <s-icon-button slot="trigger">
                    <svg viewBox="0 -969 960 960" style="transform: scale(1.25);">
                        <path
                            d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z">
                        </path>
                    </svg>
                </s-icon-button>
                <div style="min-height: 40px; width: 180px; overflow-y: auto; padding: 8px;">
                    <div class="setting-container">
                        <s-icon name="dark_mode"></s-icon>
                        <p style="margin: 0;">
                            æš—é»‘æ¨¡å¼
                        </p>
                        <s-switch id="toggleTheme"></s-switch>
                    </div>
                </div>
            </s-popup>

        </s-card>


        <s-scroll-view>
            <div id="output"></div>
        </s-scroll-view>




        <s-text-field id="prompt_input" label="è¯·è¾“å…¥Prompt" type="multiLine" style="min-height: 96px">
            <s-icon-button class="prompt_button" id="send" slot="end">
                <svg viewBox="0 -969 960 960">
                    <path
                        d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z">
                    </path>
                </svg>
            </s-icon-button>
        </s-text-field>

    </s-page>

    <!-- å¦‚æœ‰ <script src="./node_modules/sober/dist/sober.min.js"></script> ç­‰è·¯å¾„å¼•ç”¨ cloudodeï¼Œæ”¹ä¸º atode -->
    <script src="./node_modules/sober/dist/sober.min.js"></script>
    <script>
        // ç”¨æˆ·ç™»å½•ç›¸å…³ä»£ç ä¿æŒä¸å˜
        const signinButton = document.getElementById('signin-button');
        const dialog = document.querySelector('s-dialog');
        const userAvatar = document.getElementById('user-avatar');
        const registerButton = document.querySelector('s-button[type="outlined"]');
        const loginButton = document.getElementById('submit');
        const progressIndicator = document.getElementById('progress');
        const darkModeSwitch = document.querySelector('s-switch');
        const page = document.querySelector('s-page');
        let currentUser = null;

        // åˆå§‹åŒ–ä¸»é¢˜
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            page.theme = savedTheme;
            darkModeSwitch.checked = savedTheme === 'dark';
        }

        function showSnackbar(message) {
            const snackbar = document.querySelector('s-snackbar');
            const triggerDiv = snackbar.querySelector('div[slot="trigger"]');
            const messageP = snackbar.querySelector('p');
            messageP.innerText = message;
            // æ¨¡æ‹Ÿç‚¹å‡»è§¦å‘
            triggerDiv.click();
        }

        darkModeSwitch.addEventListener('click', function () {
            if (darkModeSwitch.checked) {
                page.theme = 'dark';
                localStorage.setItem('theme', 'dark');
            } else {
                page.theme = 'light';
                localStorage.setItem('theme', 'light');
            }
        });


        // æ£€æŸ¥ä¼šè¯çŠ¶æ€
        async function checkSession() {
            try {
                const response = await fetch('/api/session');
                const data = await response.json();
                if (data.success && data.user) {
                    currentUser = data.user;
                    updateUIForLoggedInUser(data.user);
                } else {
                    updateUIForLoggedOutUser();
                }
            } catch (error) {
                console.error('æ£€æŸ¥ä¼šè¯å¤±è´¥:', error);
                updateUIForLoggedOutUser();
            }
        }

        // æ›´æ–°å·²ç™»å½•ç”¨æˆ·çš„UI
        function updateUIForLoggedInUser(user) {
            const avatar = userAvatar.querySelector('s-avatar');
            avatar.innerText = user.username.substring(0, 2).toUpperCase();

            // æ›´æ–°ç”¨æˆ·èœå•
            const userMenu = document.getElementById('signin-button');
            userMenu.innerText = 'ç™»å‡º';

            console.log('ç”¨æˆ·å·²ç™»å½•:', user.username);
        }

        // æ›´æ–°æœªç™»å½•ç”¨æˆ·çš„UI
        function updateUIForLoggedOutUser() {
            const avatar = userAvatar.querySelector('s-avatar');
            avatar.innerHTML = '<svg viewBox="0 -969 960 960"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z"></path></svg>';

            // æ›´æ–°ç”¨æˆ·èœå•
            const userMenu = document.getElementById('signin-button');
            userMenu.innerText = 'ç™»å½•';

            currentUser = null;
            console.log('ç”¨æˆ·æœªç™»å½•');
        }

        // å¤„ç†ç™»å½•
        async function login() {
            const usernameField = document.querySelector('s-text-field[label="è¯·è¾“å…¥ç”¨æˆ·å"]');
            const passwordField = document.querySelector('s-text-field[label="è¯·è¾“å…¥å¯†ç "]');

            const username = usernameField.value;
            const password = passwordField.value;

            if (!username || !password) {
                showSnackbar('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼');
                return;
            }

            try {
                progressIndicator.style.display = 'inline-block';
                loginButton.disabled = true;

                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    dialog.showed = false;
                    currentUser = data.user;
                    updateUIForLoggedInUser(data.user);
                    passwordField.value = '';
                } else {
                    showSnackbar(data.error || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                showSnackbar('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                progressIndicator.style.display = 'none';
                loginButton.disabled = false;
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function register() {
            const usernameField = document.querySelector('s-text-field[label="è¯·è¾“å…¥ç”¨æˆ·å"]');
            const passwordField = document.querySelector('s-text-field[label="è¯·è¾“å…¥å¯†ç "]');

            const username = usernameField.value;
            const password = passwordField.value;

            if (!username || !password) {
                showSnackbar('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            try {
                progressIndicator.style.display = 'inline-block';
                registerButton.disabled = true;

                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSnackbar('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                    // ä¿æŒå¯¹è¯æ¡†æ‰“å¼€ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥ç™»å½•
                } else {
                    showSnackbar(data.error || 'æ³¨å†Œå¤±è´¥');
                }
            } catch (error) {
                console.error('æ³¨å†Œè¯·æ±‚å¤±è´¥:', error);
                showSnackbar('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                progressIndicator.style.display = 'none';
                registerButton.disabled = false;
            }
        }

        // å¤„ç†ç™»å‡º
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    updateUIForLoggedOutUser();
                }
            } catch (error) {
                console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('load', checkSession);

        signinButton.addEventListener('click', function () {
            if (currentUser) {
                // å·²ç™»å½•ï¼Œæ‰§è¡Œç™»å‡º
                logout();
            } else {
                // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•å¯¹è¯æ¡†
                dialog.showed = true;
            }
        });

        loginButton.addEventListener('click', login);
        registerButton.addEventListener('click', register);
    </script>
    <script>
        const output = document.getElementById('output');
        const promptInput = document.getElementById('prompt_input');
        const submitButton = document.querySelector('#send');

        // WebSocketè¿æ¥å’ŒçŠ¶æ€ç®¡ç†
        let ws = null;
        let isConnected = false;
        let isProcessing = false;
        let conversationHistory = [];
        let currentMessageId = null;

        // ä¿®æ­£SVGå›¾æ ‡
        const sendIcon = `<svg viewBox="0 -969 960 960"><path d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z"></path></svg>`;
        const stopIcon = `<svg viewBox="0 -969 960 960"><path d="M520-200v-560h240v560H520Zm-320 0v-560h240v560H200Z"></path></svg>`;

        // é…ç½® marked.js
        marked.setOptions({
            highlight: function (code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {
                        console.warn('ä»£ç é«˜äº®å¤±è´¥:', err);
                    }
                }
                try {
                    return hljs.highlightAuto(code).value;
                } catch (err) {
                    console.warn('è‡ªåŠ¨ä»£ç é«˜äº®å¤±è´¥:', err);
                    return code;
                }
            },
            langPrefix: 'hljs language-',
            breaks: true,
            gfm: true,
            sanitize: false
        });

        /**
         * ä½¿ç”¨ marked.js è§£æ Markdown å¹¶åº”ç”¨ä»£ç é«˜äº®å’Œå¤åˆ¶åŠŸèƒ½
         */
        function parseMarkdown(markdown) {
            if (!markdown || typeof markdown !== 'string') {
                return markdown;
            }

            try {
                // 1. ä½¿ç”¨ marked.js è§£æ Markdown
                let html = marked.parse(markdown);

                // 2. ä½¿ç”¨ DOMPurify æ¸…ç†HTML
                html = DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'code', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'div', 'span', 'button'],
                    ALLOWED_ATTR: ['class', 'href', 'src', 'alt', 'title', 'target', 'rel', 'onclick', 'data-clipboard-text']
                });

                return html;
            } catch (error) {
                console.error('Markdown è§£æé”™è¯¯:', error);
                return markdown;
            }
        }

        /**
         * ä¸ºæ–°æ·»åŠ çš„å†…å®¹åº”ç”¨ä»£ç é«˜äº®å’Œå¤åˆ¶åŠŸèƒ½ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
         */
        function addCopyToCodeBlocks(container) {
            if (!container) return;

            console.log('ğŸ” ä¸ºå®¹å™¨æ·»åŠ ä»£ç é«˜äº®å’Œå¤åˆ¶åŠŸèƒ½');

            // æŸ¥æ‰¾æ‰€æœ‰ä»£ç å—
            const codeBlocks = container.querySelectorAll('pre code');
            console.log(`ğŸ“¦ æ‰¾åˆ° ${codeBlocks.length} ä¸ªä»£ç å—`);

            codeBlocks.forEach((block, index) => {
                console.log(`ğŸ”¨ å¤„ç†ç¬¬ ${index + 1} ä¸ªä»£ç å—`);
                
                // ç¡®ä¿åº”ç”¨äº† highlight.jsï¼ˆåªå¯¹æ–°çš„ä»£ç å—ï¼‰
                if (typeof hljs !== 'undefined' && !block.classList.contains('hljs')) {
                    try {
                        hljs.highlightElement(block);
                        console.log(`âœ… ç¬¬ ${index + 1} ä¸ªä»£ç å—é«˜äº®æˆåŠŸ`);
                    } catch (e) {
                        console.warn(`âš ï¸ ç¬¬ ${index + 1} ä¸ªä»£ç å—é«˜äº®å¤±è´¥:`, e);
                    }
                }

                // ç¡®ä¿ pre å…ƒç´ æœ‰æ­£ç¡®çš„ç±»å’Œæ ·å¼
                const preElement = block.parentElement;
                if (preElement && preElement.tagName === 'PRE') {
                    // è®¾ç½®æ ·å¼ï¼Œæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨æ¡
                    preElement.style.position = 'relative';
                    
                    // æ£€æŸ¥å†…å®¹æ˜¯å¦éœ€è¦æ°´å¹³æ»šåŠ¨
                    const needsHorizontalScroll = block.scrollWidth > preElement.clientWidth;
                    if (needsHorizontalScroll) {
                        preElement.classList.add('code-overflow');
                    } else {
                        preElement.style.overflow = 'hidden';
                    }
                    
                    // å¦‚æœè¿˜æ²¡æœ‰å¤åˆ¶æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ªï¼ˆé˜²é‡å¤ï¼‰
                    if (!preElement.querySelector('.hljs-copy-button')) {
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'hljs-copy-button';
                        copyBtn.innerHTML = 'å¤åˆ¶';
                        copyBtn.type = 'button';
                        
                        // æ ‡è®°å·²å¤„ç†ï¼Œé˜²æ­¢é‡å¤æ·»åŠ 
                        copyBtn.setAttribute('data-processed', 'true');
                        
                        // é˜²æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
                        copyBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const text = block.textContent || block.innerText;
                            navigator.clipboard.writeText(text).then(() => {
                                showSnackbar('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                                console.log('ğŸ“‹ æ‰‹åŠ¨å¤åˆ¶æˆåŠŸ');
                                
                                // ä¸´æ—¶æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = 'å·²å¤åˆ¶';
                                copyBtn.style.background = 'rgba(0, 128, 0, 0.2)';
                                
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.style.background = '';
                                }, 1000);
                            }).catch(err => {
                                console.error('âŒ å¤åˆ¶å¤±è´¥:', err);
                                showSnackbar('å¤åˆ¶å¤±è´¥');
                            });
                        });
                        
                        preElement.appendChild(copyBtn);
                        console.log(`âœ… ç¬¬ ${index + 1} ä¸ªä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®æˆåŠŸ`);
                    }
                }
            });

            console.log('âœ… ä»£ç å—å¤„ç†å®Œæˆ');
        }

        /**
         * é’ˆå¯¹æµå¼ä¼ è¾“ä¼˜åŒ–çš„ä»£ç å—å¤„ç†å‡½æ•°
         */
        function updateCodeBlocksForStreaming(container) {
            if (!container) return;

            // åªæŸ¥æ‰¾æ–°çš„ã€æœªå¤„ç†çš„ä»£ç å—
            const newCodeBlocks = container.querySelectorAll('pre code:not([data-streaming-processed])');
            
            newCodeBlocks.forEach((block, index) => {
                // æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé¿å…é‡å¤å¤„ç†
                block.setAttribute('data-streaming-processed', 'true');
                
                // ç¡®ä¿åº”ç”¨äº† highlight.js
                if (typeof hljs !== 'undefined' && !block.classList.contains('hljs')) {
                    try {
                        hljs.highlightElement(block);
                    } catch (e) {
                        console.warn(`âš ï¸ æµå¼ä»£ç å—é«˜äº®å¤±è´¥:`, e);
                    }
                }

                const preElement = block.parentElement;
                if (preElement && preElement.tagName === 'PRE') {
                    preElement.style.position = 'relative';
                    preElement.style.overflow = 'hidden';
                    
                    // åªåœ¨æ²¡æœ‰å¤åˆ¶æŒ‰é’®æ—¶æ·»åŠ 
                    if (!preElement.querySelector('.hljs-copy-button')) {
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'hljs-copy-button';
                        copyBtn.innerHTML = 'å¤åˆ¶';
                        copyBtn.type = 'button';
                        copyBtn.setAttribute('data-processed', 'true');
                        
                        copyBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const text = block.textContent || block.innerText;
                            navigator.clipboard.writeText(text).then(() => {
                                showSnackbar('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                                
                                const originalText = copyBtn.innerHTML;
                                copyBtn.innerHTML = 'å·²å¤åˆ¶';
                                copyBtn.style.background = 'rgba(0, 128, 0, 0.2)';
                                
                                setTimeout(() => {
                                    copyBtn.innerHTML = originalText;
                                    copyBtn.style.background = '';
                                }, 1000);
                            }).catch(err => {
                                console.error('âŒ å¤åˆ¶å¤±è´¥:', err);
                                showSnackbar('å¤åˆ¶å¤±è´¥');
                            });
                        });
                        
                        preElement.appendChild(copyBtn);
                    }
                }
            });

            console.log('âœ… ä»£ç å—å¤„ç†å®Œæˆ');
        }

        // åˆå§‹åŒ– highlight.js å’Œå¤åˆ¶åŠŸèƒ½
        function initializeHighlightJS() {
            // ç¡®ä¿ highlight.js å·²åŠ è½½
            if (typeof hljs !== 'undefined') {
                console.log('âœ… Highlight.js å·²åŠ è½½');
                
                // é…ç½® highlight.js
                hljs.configure({
                    languages: ['javascript', 'python', 'java', 'cpp', 'html', 'css', 'json', 'xml', 'bash', 'sql'],
                    ignoreUnescapedHTML: true
                });

                // åˆå§‹åŒ–å¤åˆ¶æ’ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if (typeof CopyButtonPlugin !== 'undefined') {
                    console.log('âœ… CopyButtonPlugin å·²åŠ è½½');
                    try {
                        hljs.addPlugin(new CopyButtonPlugin({
                            lang: "zh-CN",
                            callback: (text, el) => {
                                console.log('ğŸ“‹ æ’ä»¶å¤åˆ¶æˆåŠŸ:', text.substring(0, 50) + '...');
                                showSnackbar("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
                            },
                        }));
                    } catch (e) {
                        console.warn('âš ï¸ CopyButtonPlugin åˆå§‹åŒ–å¤±è´¥:', e);
                    }
                } else {
                    console.warn('âš ï¸ CopyButtonPlugin æœªåŠ è½½ï¼Œä½¿ç”¨æ‰‹åŠ¨å¤åˆ¶æ–¹æ¡ˆ');
                }
            } else {
                console.warn('âš ï¸ Highlight.js æœªåŠ è½½');
            }
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            const wsUrl = `ws://${window.location.host}`;
            console.log('ğŸ”Œ è¿æ¥WebSocket:', wsUrl);

            ws = new WebSocket(wsUrl);

            ws.onopen = function (event) {
                console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                isConnected = true;
            };

            ws.onmessage = function (event) {
                console.log('ğŸ”” åŸå§‹WebSocketæ¶ˆæ¯:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('âŒ æ¶ˆæ¯è§£æå¤±è´¥:', error, 'åŸå§‹æ•°æ®:', event.data);
                }
            };

            ws.onclose = function (event) {
                console.log('âŒ WebSocketè¿æ¥å…³é—­', event.code, event.reason);
                isConnected = false;
                isProcessing = false;

                // 5ç§’åå°è¯•é‡è¿
                setTimeout(initWebSocket, 5000);
            };

            ws.onerror = function (error) {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(message) {
            console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ç±»å‹:', message.type);

            switch (message.type) {
                case 'processing_start':
                    console.log('ğŸš€ å¼€å§‹å¤„ç†...');
                    isProcessing = true;
                    setProcessingState(true);
                    currentMessageId = `msg-${Date.now()}`;
                    const startDiv = `<div id="${currentMessageId}"><p><strong>AIï¼š</strong>æ­£åœ¨å¤„ç†...</p></div>`;
                    output.innerHTML += startDiv;
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    requestAnimationFrame(() => {
                        output.scrollTop = output.scrollHeight;
                    });
                    break;

                case 'coordination_progress':
                    console.log('ğŸ”„ åè°ƒè¿›åº¦:', message.message);
                    const progressContainer = document.getElementById(currentMessageId);
                    if (progressContainer) {
                        progressContainer.innerHTML = `<p><strong>AIï¼š</strong>ğŸš€ ${message.stage}/6 ${message.message}</p>`;
                        // ä¿æŒæ»šåŠ¨ä½ç½®åœ¨åº•éƒ¨
                        requestAnimationFrame(() => {
                            output.scrollTop = output.scrollHeight;
                        });
                    }
                    break;

                case 'stream_start':
                    console.log('ğŸŸ¢ å¼€å§‹æµå¼ä¼ è¾“');
                    const startContainer = document.getElementById(currentMessageId);
                    if (startContainer) {
                        startContainer.innerHTML = `<p><strong>AIï¼š</strong></p><div class="markdown-content">å¼€å§‹æ¥æ”¶å†…å®¹...</div>`;
                        // ä¿æŒæ»šåŠ¨ä½ç½®åœ¨åº•éƒ¨
                        requestAnimationFrame(() => {
                            output.scrollTop = output.scrollHeight;
                        });
                    }
                    break;

                case 'stream_chunk':
                    console.log('ğŸ“¦ æ”¶åˆ°æ•°æ®å—ï¼Œå†…å®¹é•¿åº¦:', message.fullContent ? message.fullContent.length : 0);

                    const container = document.getElementById(currentMessageId);
                    if (container) {
                        if (message.fullContent) {
                            let contentDiv = container.querySelector('.markdown-content');
                            if (!contentDiv) {
                                contentDiv = document.createElement('div');
                                contentDiv.className = 'markdown-content';
                                container.innerHTML = '<p><strong>AIï¼š</strong></p>';
                                container.appendChild(contentDiv);
                            }

                            try {
                                contentDiv.innerHTML = parseMarkdown(message.fullContent);
                                // ä½¿ç”¨æµå¼ä¼˜åŒ–çš„å¤„ç†å‡½æ•°ï¼Œé¿å…é‡å¤å¤„ç†
                                updateCodeBlocksForStreaming(contentDiv);
                                
                                // åªæœ‰åœ¨ç”¨æˆ·æ²¡æœ‰ä¸»åŠ¨æ»šåŠ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                const isUserScrolledUp = output.scrollTop < (output.scrollHeight - output.clientHeight - 100);
                                if (!isUserScrolledUp) {
                                    requestAnimationFrame(() => {
                                        output.scrollTop = output.scrollHeight;
                                    });
                                }
                            } catch (parseError) {
                                console.error('âŒ Markdownè§£æå¤±è´¥:', parseError);
                                contentDiv.textContent = message.fullContent;
                            }
                        }
                    }
                    break;

                case 'stream_complete':
                    console.log('âœ… æµå¼ä¼ è¾“å®Œæˆ');
                    if (currentMessageId) {
                        const container = document.getElementById(currentMessageId);
                        if (container) {
                            const finalContent = message.fullContent || message.content || '';

                            let contentDiv = container.querySelector('.markdown-content');
                            if (!contentDiv) {
                                contentDiv = document.createElement('div');
                                contentDiv.className = 'markdown-content';
                                container.innerHTML = '<p><strong>AIï¼š</strong></p>';
                                container.appendChild(contentDiv);
                            }

                            if (finalContent) {
                                try {
                                    contentDiv.innerHTML = parseMarkdown(finalContent);
                                    // æœ€ç»ˆå¤„ç†ï¼Œæ£€æŸ¥æ‰€æœ‰ä»£ç å—çš„æ»šåŠ¨éœ€æ±‚
                                    addCopyToCodeBlocks(contentDiv);
                                    conversationHistory.push({ role: 'assistant', content: finalContent });
                                } catch (parseError) {
                                    console.error('âŒ æœ€ç»ˆå†…å®¹è§£æå¤±è´¥:', parseError);
                                    contentDiv.textContent = finalContent;
                                }
                            } else {
                                contentDiv.innerHTML = '<p><em>æœªæ”¶åˆ°å†…å®¹</em></p>';
                            }
                            
                            // å®Œæˆåç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä½†ä½¿ç”¨å¹³æ»‘æ»šåŠ¨
                            requestAnimationFrame(() => {
                                output.scrollTo({
                                    top: output.scrollHeight,
                                    behavior: 'smooth'
                                });
                            });
                        }
                    }
                    isProcessing = false;
                    setProcessingState(false);
                    break;

                case 'error':
                    console.error('âŒ æ”¶åˆ°é”™è¯¯:', message.message);
                    isProcessing = false;
                    setProcessingState(false);
                    output.innerHTML += `<p><strong>é”™è¯¯:</strong> ${message.message}</p>`;
                    // é”™è¯¯ä¿¡æ¯ä¹Ÿéœ€è¦æ»šåŠ¨åˆ°åº•éƒ¨
                    requestAnimationFrame(() => {
                        output.scrollTop = output.scrollHeight;
                    });
                    break;

                default:
                    console.log('â“ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type, message);
            }

            // ç§»é™¤è¿™é‡Œçš„ç»Ÿä¸€æ»šåŠ¨è°ƒç”¨ï¼Œè®©æ¯ä¸ªcaseè‡ªå·±æ§åˆ¶
            // output.scrollTop = output.scrollHeight;
        }

        // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
        async function sendPromptWebSocket() {
            const prompt = promptInput.value.trim();

            if (!prompt) {
                showSnackbar('è¯·è¾“å…¥å†…å®¹');
                return;
            }

            if (!currentUser) {
                showSnackbar('è¯·å…ˆç™»å½•åå†ä½¿ç”¨AIåŠŸèƒ½ã€‚');
                dialog.showed = true;
                return;
            }

            if (!isConnected) {
                showSnackbar('WebSocketæœªè¿æ¥ï¼Œè¯·ç­‰å¾…è¿æ¥æ¢å¤');
                return;
            }

            if (isProcessing) {
                showSnackbar('AIæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™');
                return;
            }

            // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
            output.innerHTML += `<p><strong>ç”¨æˆ·:</strong> ${prompt}</p>`;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²è®°å½•
            conversationHistory.push({
                role: 'user',
                content: prompt
            });

            // æ™ºèƒ½è¯†åˆ«ä»»åŠ¡ç±»å‹ï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨åè°ƒå™¨
            const lowerPrompt = prompt.toLowerCase();

            // æ£€æµ‹ç¼–ç¨‹éœ€æ±‚ï¼ˆéœ€è¦ä½¿ç”¨åè°ƒå™¨çš„ä¸“ä¸šä»»åŠ¡ï¼‰
            const isProgrammingRequest = /python|java|c\+\+|javascript|node\.?js|ç¼–ç¨‹|ä»£ç |ç®—æ³•|å‡½æ•°|è„šæœ¬/.test(lowerPrompt) ||
                /æ•°æ®åˆ†æ|æœºå™¨å­¦ä¹ |æ·±åº¦å­¦ä¹ |çˆ¬è™«|api|æ•°æ®åº“/.test(lowerPrompt) ||
                /ç½‘é¡µ|ç½‘ç«™|å‰ç«¯|html|css|é¡µé¢|ç•Œé¢|å¸ƒå±€/.test(lowerPrompt);

            // æ£€æµ‹å†™ä½œéœ€æ±‚
            const isWritingRequest = /å†™.*?(å°è¯´|æ•…äº‹|æ–‡ç« |æ•£æ–‡|è¯—æ­Œ|å‰§æœ¬|æ—¥è®°|ä¼ è®°|æŠ¥å‘Š|è®ºæ–‡|è¯´æ˜|ä»‹ç»|åˆ†æ|è¯„è®º|æ€»ç»“)/.test(lowerPrompt) ||
                /åˆ›ä½œ.*?(å°è¯´|æ•…äº‹|æ–‡ç« |æ•£æ–‡|è¯—æ­Œ|å‰§æœ¬)/.test(lowerPrompt);

            // æ˜ç¡®çš„å¦å®šç¼–ç¨‹
            const explicitNoCode = /ä¸è¦.*ä»£ç |ä¸å†™.*ä»£ç |ä¸éœ€è¦.*ä»£ç |åªè¦.*æ–‡å­—|åªéœ€è¦.*æ–‡å­—|çº¯æ–‡å­—/.test(lowerPrompt);

            // å†³å®šæ˜¯å¦ä½¿ç”¨åè°ƒå™¨
            let useCoordinator;
            if (isWritingRequest || explicitNoCode) {
                useCoordinator = true;
                console.log('ğŸ“ è¯†åˆ«ä¸ºæ–‡å­—åˆ›ä½œéœ€æ±‚ï¼Œä½¿ç”¨å†™ä½œä¸“å®¶');
            } else if (isProgrammingRequest) {
                useCoordinator = true;
                console.log('ğŸ’» è¯†åˆ«ä¸ºç¼–ç¨‹éœ€æ±‚ï¼Œä½¿ç”¨ä¸“ä¸šç¼–ç¨‹ä¸“å®¶');
            } else {
                useCoordinator = false;
                console.log('ğŸ’¬ è¯†åˆ«ä¸ºä¸€èˆ¬é—®ç­”ï¼Œä½¿ç”¨åŸºç¡€AI');
            }

            console.log(`ğŸ¤– æ™ºèƒ½åˆ¤æ–­: ç¼–ç¨‹éœ€æ±‚=${isProgrammingRequest}, å†™ä½œéœ€æ±‚=${isWritingRequest}, æ˜ç¡®ä¸è¦ä»£ç =${explicitNoCode}, ä½¿ç”¨åè°ƒå™¨=${useCoordinator}`);

            // é€šè¿‡WebSocketå‘é€è¯·æ±‚
            const message = {
                prompt: prompt,
                history: conversationHistory,
                useCoordinator: useCoordinator
            };

            console.log('ğŸ“¤ å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨:', message);
            ws.send(JSON.stringify(message));

            promptInput.value = '';
            
            // å‘é€æ¶ˆæ¯åè®©è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼Œä¸é‡æ–°èšç„¦
            promptInput.blur();
            
            // å‘é€æ¶ˆæ¯åæ»šåŠ¨åˆ°åº•éƒ¨
            requestAnimationFrame(() => {
                output.scrollTop = output.scrollHeight;
            });
        }

        // åœæ­¢å¤„ç†
        async function stopProcessing() {
            if (isConnected && ws) {
                ws.send(JSON.stringify({ type: 'stop_task' }));
            }

            // ç«‹å³æ›´æ–°UIçŠ¶æ€
            isProcessing = false;
            setProcessingState(false);

            // ç«‹å³åœ¨UIä¸Šæ˜¾ç¤ºä»»åŠ¡å·²åœæ­¢
            const container = document.getElementById(currentMessageId);
            if (container) {
                container.innerHTML += '<p><strong>ç³»ç»Ÿ:</strong> ä»»åŠ¡å·²åœæ­¢ã€‚</p>';
            }
        }

        function setProcessingState(processing) {
            isProcessing = processing;
            if (processing) {
                submitButton.innerHTML = stopIcon;
                submitButton.setAttribute('aria-label', 'åœæ­¢å¤„ç†');
            } else {
                submitButton.innerHTML = sendIcon;
                submitButton.setAttribute('aria-label', 'å‘é€æ¶ˆæ¯');
            }
        }

        // å¿ƒè·³æ£€æµ‹
        function startHeartbeat() {
            setInterval(() => {
                if (isConnected && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 30000); // 30ç§’å¿ƒè·³
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–WebSocketå’Œä»£ç å¤åˆ¶åŠŸèƒ½
        window.addEventListener('load', () => {
            // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿æ‰€æœ‰å¤–éƒ¨è„šæœ¬éƒ½å·²åŠ è½½
            setTimeout(initializeHighlightJS, 100);
            initWebSocket();
            startHeartbeat();
            
            // ç§»é™¤é¡µé¢åŠ è½½åçš„è‡ªåŠ¨èšç„¦
            // setTimeout(() => {
            //     promptInput.focus();
            // }, 200);
        });

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });

        // æ–°å»ºå¯¹è¯åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const newChatButton = document.getElementById('new-chat');

            newChatButton.addEventListener('click', async () => {
                await startNewChat();
            });
        });

        // æ–°å»ºå¯¹è¯å‡½æ•°
        async function startNewChat() {
            // å¦‚æœå½“å‰æœ‰å¯¹è¯å†…å®¹ä¸”ç”¨æˆ·å·²ç™»å½•ï¼Œå…ˆä¿å­˜åˆ°å†å²è®°å½•
            if (currentUser && conversationHistory.length > 0) {
                await saveChatHistory();
            }

            // æ¸…ç©ºå½“å‰å¯¹è¯
            output.innerHTML = '';
            conversationHistory = [];
            currentMessageId = null;

            // å¦‚æœæ­£åœ¨å¤„ç†ä¸­ï¼Œåœæ­¢å¤„ç†
            if (isProcessing) {
                await stopProcessing();
            }

            // ç§»é™¤æ–°å»ºå¯¹è¯åçš„è‡ªåŠ¨èšç„¦
            // setTimeout(() => {
            //     promptInput.focus();
            // }, 50);

            console.log('âœ… å·²å¼€å§‹æ–°å¯¹è¯');
        }

        // å†å²è®°å½•ç›¸å…³åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const historyPopup = document.querySelector('s-popup.menu-button');
            const historyTrigger = historyPopup.querySelector('[slot="trigger"]');

            // ç‚¹å‡»å†å²è®°å½•æŒ‰é’®æ—¶åŠ è½½å†å²è®°å½•
            historyTrigger.addEventListener('click', () => {
                if (currentUser) {
                    loadChatHistory();
                } else {
                    document.getElementById('history-list').innerHTML = `
                            <div style="text-align: center; padding: 16px;">
                                è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹å†å²è®°å½•
                            </div>
                        `;
                }
            });
        });

        // åŠ è½½èŠå¤©å†å²è®°å½•
        async function loadChatHistory() {
            const historyList = document.getElementById('history-list');
            const historyEmpty = document.getElementById('history-empty');

            historyList.innerHTML = `
                    <div class="history-loading" style="text-align: center; padding: 16px;">
                        åŠ è½½ä¸­...
                    </div>
                `;
            historyEmpty.style.display = 'none';

            try {
                const response = await fetch('/api/ai/history');
                const data = await response.json();

                if (data.success) {
                    if (data.history && data.history.length > 0) {
                        historyList.innerHTML = '';

                        data.history.forEach(history => {
                            const date = new Date(history.created_at);
                            const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                            const historyItem = document.createElement('s-ripple');
                            historyItem.className = 'history-item';
                            historyItem.style.cssText = 'padding: 10px; border-radius: 4px; background-color: var(--color-card); cursor: pointer; position: relative;';
                            historyItem.innerHTML = `
                                    <div style="margin-bottom: 4px; font-weight: bold; padding-right: 24px;">${history.title}</div>
                                    <div style="font-size: 0.8em; color: #666;">${formattedDate}</div>
                                    <div class="delete-history" data-id="${history.id}" style="position: absolute; right: 8px; top: 8px; width: 24px; height: 16px; opacity: 0.6; fill: var(--color-icon); cursor: pointer;">
                                        <svg viewBox="0 -969 960 960">
                                            <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"></path>
                                        </svg>
                                    </div>
                                `;

                            // åŠ è½½èŠå¤©å†…å®¹
                            historyItem.addEventListener('click', (e) => {
                                // å¿½ç•¥åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»
                                if (!e.target.closest('.delete-history')) {
                                    loadHistoryContent(history.content);
                                }
                            });

                            historyList.appendChild(historyItem);
                        });

                        // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
                        document.querySelectorAll('.delete-history').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const historyId = btn.getAttribute('data-id');
                                deleteHistory(historyId);
                            });
                        });
                    } else {
                        historyList.innerHTML = '';
                        historyEmpty.style.display = 'block';
                    }
                } else {
                    historyList.innerHTML = `
                            <div style="text-align: center; padding: 16px; color: red;">
                                åŠ è½½å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}
                            </div>
                        `;
                }
            } catch (error) {
                historyList.innerHTML = `
                        <div style="text-align: center; padding: 16px; color: red;">
                            åŠ è½½å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}
                        </div>
                    `;
            }
        }

        // åŠ è½½å†å²å¯¹è¯å†…å®¹
        function loadHistoryContent(contentJson) {
            try {
                // æ¸…ç©ºå½“å‰å¯¹è¯
                output.innerHTML = '';

                // è§£æèŠå¤©å†å²
                const history = JSON.parse(contentJson);
                conversationHistory = history;

                // æ˜¾ç¤ºå†å²å¯¹è¯
                let msgId = 1;
                history.forEach(msg => {
                    if (msg.role === 'user') {
                        output.innerHTML += `<p><strong>ç”¨æˆ·:</strong> ${msg.content}</p>`;
                    } else if (msg.role === 'assistant') {
                        const id = `msg-history-${msgId++}`;
                        const messageDiv = document.createElement('div');
                        messageDiv.id = id;
                        messageDiv.innerHTML = `<p><strong>AIï¼š</strong></p><div class="markdown-content">${parseMarkdown(msg.content)}</div>`;
                        output.appendChild(messageDiv);

                        // ä¸ºæ–°æ·»åŠ çš„ä»£ç å—æ·»åŠ å¤åˆ¶åŠŸèƒ½
                        setTimeout(() => {
                            addCopyToCodeBlocks(messageDiv);
                        }, 100);
                    }
                });

                // å…³é—­å¼¹å‡ºçª—å£
                const popup = document.querySelector('s-popup.menu-button');
                popup.removeAttribute('opened');

                // åŠ è½½å†å²è®°å½•åæ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => { 
                    output.scrollTo({
                        top: output.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 300);
            } catch (error) {
                console.error('åŠ è½½å†å²å†…å®¹å¤±è´¥:', error);
                showSnackbar('åŠ è½½å†å²å†…å®¹å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤å†å²è®°å½•
        async function deleteHistory(historyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/ai/history/${historyId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // é‡æ–°åŠ è½½å†å²è®°å½•
                    loadChatHistory();
                } else {
                    showSnackbar('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤å†å²è®°å½•å¤±è´¥:', error);
                showSnackbar('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜èŠå¤©å†å²
        async function saveChatHistory() {
            if (!currentUser || conversationHistory.length === 0) {
                return;
            }

            try {
                // è·å–ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
                const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
                if (!firstUserMessage) return;

                // æˆªå–æ ‡é¢˜ï¼ˆæœ€å¤š50ä¸ªå­—ç¬¦ï¼‰
                const title = firstUserMessage.content.length > 50
                    ? firstUserMessage.content.substring(0, 47) + '...'
                    : firstUserMessage.content;

                // å‡†å¤‡å®Œæ•´å¯¹è¯å†…å®¹
                const content = JSON.stringify(conversationHistory);

                // å‘é€ä¿å­˜è¯·æ±‚
                const response = await fetch('/api/ai/save-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content })
                });

                const data = await response.json();

                if (!data.success) {
                    console.error('ä¿å­˜èŠå¤©å†å²å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜èŠå¤©å†å²å¤±è´¥:', error);
            }
        }

        // ä¿®æ”¹ handleWebSocketMessage å‡½æ•°æ¥åŒ…å«ä¿å­˜å†å²è®°å½•çš„åŠŸèƒ½
        const originalHandleWebSocketMessage = handleWebSocketMessage;
        
        // é‡æ–°å®šä¹‰ handleWebSocketMessage å‡½æ•°
        function handleWebSocketMessageWithHistory(message) {
            // è°ƒç”¨åŸå§‹çš„å¤„ç†å‡½æ•°
            originalHandleWebSocketMessage(message);

            // åœ¨æµå¼ä¼ è¾“å®Œæˆåä¿å­˜å†å²è®°å½•
            if (message.type === 'stream_complete') {
                saveChatHistory();
            }
        }

        // æ›¿æ¢æ¶ˆæ¯å¤„ç†å‡½æ•°
        handleWebSocketMessage = handleWebSocketMessageWithHistory;

        // highlightjs-copy åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // ç»™æ‰€æœ‰ä»£ç å—åŠ  hljs-copy ç±»
            document.querySelectorAll('pre code').forEach(function (block) {
                if (block.parentElement) {
                    block.parentElement.classList.add('hljs-copy');
                }
            });
        });

        // æ”¯æŒæŒ‰ä¸‹ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
        promptInput.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                // ç›´æ¥è°ƒç”¨å‘é€å‡½æ•°ï¼Œè€Œä¸æ˜¯ç‚¹å‡»æŒ‰é’®
                sendPromptWebSocket();
            }
        });

        // ç›‘å¬æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        submitButton.addEventListener('click', async (event) => {
            event.preventDefault();

            if (isProcessing) {
                await stopProcessing();
            } else {
                await sendPromptWebSocket();
            }
        });

        // ç›‘å¬è¡¨å•æäº¤äº‹ä»¶
        promptInput.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!isProcessing) {
                await sendPromptWebSocket();
            }
        });
    </script>
</body>

</html>